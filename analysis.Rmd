---
title: "Adapting reintroduction tactics in successive trials increases the likelihood of establishment for an endangered carnivore in a fenced sanctuary"
author: "Wilson B A, Evans M J, Batson W G, Banks S C, Gordon I J,  Fletcher D B, Wimpenny C, Newport J, Belton E, Rypalski A, Portas T & Manning A D"
date: "21 September 2021"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: united
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

# **1. Spatial analysis**

## **1.1 Load, project, and plot MFWS shapefile**

```{r, results='hide', warning=FALSE, message=FALSE}

#library(adehabitatLT), library(circular), library(maptools)
#library(move), library(raster), library(RCurl), library(readr)
#library(rgeos), library(xts)

library(sp)
library(rgdal)
library(maptools)
library(ggmap)
library(ggplot2)
```
  
```{r, results='hide', warning=FALSE, message=FALSE}
mfws <- readOGR(dsn=path.expand("C:/Users/belsp/Google Drive/Academia/Australian National University/Projects/Eastern quoll/Spatial/Data/GIS/mfws_fence.shp"))
mfws <- spTransform(mfws, CRS("+proj=utm +zone=55 +ellps=WGS84"))
mfws <- fortify(mfws) #library(ggplot2)

setwd("C:/Users/belsp/Google Drive/Academia/Australian National University/Projects/Eastern quoll/Tactics/Data/R")
den <- read.csv("0 raw den data.csv")
plot(mfws, axes=T)

ggplot() +
  geom_path(mfws, mapping=aes(x=long, y=lat, group=group), colour="black") +
  geom_point(den, mapping=aes(x=X, y=Y), size=1, col="darkblue", alpha=0.1) +
  xlab("") + ylab("") +
  coord_sf(xlim = c(149.145, 149.19), ylim = c(-35.185, -35.155))
```

## **1.2 Cluster dens**

  1. Create clusters for dens within 10m of one another

```{r}
setwd("...")
den <- read.csv('0 raw den data.csv') #read data
den <- subset(den,BankID!="EQ15" & BankID!="EQ16" & BankID!="EQ17" & 
                DenID!="119" & DenID!="1682" & History=="Alive" & 
                X!="NA" & DaysPostRelease<43)

xy <- data.frame(cbind(den$X,den$Y)) #created xy dataframe
distxy <- dist(xy) #create distance matrix
chc <- hclust(distxy) #hierarchical clustering
chc.d10 <- cutree(chc, h=12) #distance with a 10m threshold 
den$cluster <- chc.d10 #append to the end of the datasheet
write.csv(den,file="1 clusters.csv") #write to file
```

  2. Calculate mean eastings and northings for each cluster

```{r}
clusterdata <- read.csv('1 clusters.csv') #read data
meanclusters <- ddply(clusterdata, .(cluster), summarize,  X2=mean(X), Y2=mean(Y))
vlookup <- merge(clusterdata,meanclusters, by= "cluster" )
vlookup <- arrange(vlookup,DenID) #arranges the data frame by DenID
clusterdata <- arrange(clusterdata,DenID) #makes sure that they are in the same order
clusterdata$meanX <- vlookup$X2
clusterdata$meanY <- vlookup$Y2
write.csv(vlookup,file="2 mean_clusters.csv")
```

## **1.3 Distance per day**

Load MFWS polygon shapefile.

```{r}
mfws <- readOGR(dsn=path.expand("Z:/MULLIGANS-GOOROOYARROO/DATA/GIS/Eastern_quoll/PhDEQ/MFWS/final_fence_polygon_Apr09.shp")) #load MFWS shapefile   
```

Calculate distances travelled for the first quoll, "EQ01".

```{r}
den <- subset(clusterdata,DaysBetween==1) #subset for consecutive days
EQ <- subset(den, BankID=="EQ01")
EQ$BankID <- factor(EQ$BankID) #converts to factor

EQ <- subset(den, BankID=="EQ01")
EQ$BankID <- factor(EQ$BankID) #converts to factor
pdate <- as.POSIXct(strptime(as.character(EQ$POSIXdate), "%Y.%m.%d ")) #convert date to a format POSIX needs
data.xy=EQ[c("meanX", "meanY")]
xysp <- SpatialPoints(data.xy) #creates a class Spatial Points for all locations
proj4string(xysp) <- CRS("+proj=utm +zone=55 +ellps=WGS84")

sppt <- data.frame(xysp) #creates a Spatial Data Frame from sppt
idsp <- data.frame(EQ$BankID) #creates a spatial data frame of ID
merge <- data.frame(idsp) #merges ID and Date into the same spatial data frame
coordinates(merge) <- sppt #adds ID and Date data frame with locations data frame
move <- as.ltraj(xy=EQ[,c("meanX","meanY")], date=pdate, id=idsp) #creates an object of class ltraj to store movements

jpeg(file="EQ01_plot.jpeg", width=5500, height=5000, units="px", res=800)
plot(move,xlim=c(695750,699250),ylim=c(6104250,6107750),xlab="Easting",ylab="Northing",main="EQ01")
plot(mfws, add=T)
dev.off()

distEQ <- move[[1]]
distEQ$BankID <- "EQ01"
sum.table <- cbind(EQ,distEQ)
```

```{r}
distEQ <- move[[1]]
distEQ$BankID <- "EQ01"
sum.table <- cbind(EQ,distEQ)
EQIDs <- levels(den$BankID) #creates vector that loop looks at to get values
EQIDs <- EQIDs[c(2:length(EQIDs))] #removes the first one to avoid duplicate later on

for(i in EQIDs){
  EQ <- subset(den, BankID==i)
  EQ$BankID <- factor(EQ$BankID) #converts to factor
  pdate <- as.POSIXct(strptime(as.character(EQ$POSIXdate),"%Y.%m.%d")) #convert date to a format POSIX needs
  data.xy=EQ[c("meanX", "meanY")]
  xysp <- SpatialPoints(data.xy) #creates a class Spatial Points for all locations
  proj4string(xysp) <- CRS("+proj=utm +zone=55 +ellps=WGS84")
  
  sppt <- data.frame(xysp) #creates a Spatial Data Frame from sppt
  idsp <- data.frame(EQ$BankID) #creates a spatial data frame of ID
  merge <- data.frame(idsp) #merges ID and Date into the same spatial data frame
  coordinates(merge) <- sppt #adds ID and Date data frame with locations data frame
  move <- as.ltraj(xy=EQ[,c("meanX","meanY")], date=pdate, id=idsp) #creates an object of class ltraj to store movements
  
  jpeg(file=paste(i,"plot.jpeg",sep="_"), width=5500, height=5000, units="px", res=800)
  plot(move,xlim=c(695750,699250),ylim=c(6104250,6107750),xlab="Easting",ylab="Northing",main=paste(i))
  plot(mfws, add=T)
  dev.off()
  
  distEQ <- move[[1]]
  distEQ$BankID <- i
  EQtable <- cbind(EQ,distEQ)
  sum.table <- rbind(sum.table,EQtable)
}

write.csv(sum.table, file="3 mean_clusters_daily_distance.csv")
```

## **1.4 Distance from release site**

```{r}
den <- read.csv('1 mean_cluster.csv')
dfr <- den$dfr <- sqrt((den$ReleaseX-den$meanX)^2+(den$ReleaseY-den$meanY)^2)
write.csv(den,file="3 mean_cluster_dfr.csv")
```

# **2. Models**

## **2.1 Data preparation**

```{r}
library(effects)
library(brglm)
library(ggplot2)
library(MuMIn)
library(lme4)
library(lsmeans)
library(multcomp)
library(boot)

setwd("C:/Users/belsp/Google Drive/Academia/Australian National University/Projects/Eastern quoll/Tactics/Data/R")
animal <- read.csv('0 raw animal data.csv') #read data

animal$Year <- factor(animal$Year)
animal$MovedPerc <- as.numeric(as.character(animal$MovedPerc))
animal$DistanceMean <- as.numeric(as.character(animal$DistanceMean))
animal$DistanceMeanZero <- as.numeric(as.character(animal$DistanceMeanZero))
animal$Fate <- ifelse(animal$Fate=="Survived",1,0) #probability variable

animal <- subset(animal, BankID!="EQ15" & BankID!="EQ16" & 
                   BankID!="EQ17" & BankID!="EQ25" & 
                   BankID!="EQ32" & BankID!="EQ33" & 
                   BankID!="EQ34" & BankID!="EQ35" & 
                   BankID!="EQ36" & BankID!="EQ37" & 
                   BankID!="EQ38" & BankID!="EQ39" & 
                   Year!="2017" & Year!="2018" & Year!="2018")

femanimal <- subset(animal,Sex!="M" & Year!="2016")

codenanimal <- subset(animal,BankID!="EQ02" & BankID!="EQ05" & 
                        BankID!="EQ10" & BankID!="EQ11" & 
                        BankID!="EQ12" & BankID!="EQ29")
```

## **2.2 Survival models**

### **Model 01 - Survival by trial (Fig 2A)**

```{r}
animal$Trial <- factor(animal$Trial)
mod <- glm(Fate~Trial, data=animal, family=binomial(link=logit))
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Trial="Tukey"))  
ph <- cld(pw,alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Trial="Tukey")))

jpeg(file=paste("Model 1 - Survival ~ Trial (Fig 2A).jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Trial)
effects$Trial <- factor(effects$Trial)
effects$tukey <- c("a","b","b")

mod1 <- ggplot(effects, aes(x=Trial, y=fit, group=1)) + 
  geom_errorbar(aes(ymin=lower, ymax=upper), colour="orange", width=0.1) +
  geom_point(shape=21,size=3,fill="orange",colour="orange") +
  theme(axis.line=element_line(colour="black"), legend.position="none",
        panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), axis.title=element_text(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04)) +
  xlab("Trial") + ylab("Probability of survival") +
  geom_text(aes(x=Trial, y=upper,label=tukey),nudge_y=0.05)
dev.off()
mod1
```

### **Model 02 - Survival by origin**

```{r}
mod <- glm(Fate~Origin, data=animal, family=binomial(link=logit))
summary(mod)
anova(mod,test=c("Chisq"))

    mod <- glm(Fate~Origin, data=animal20162017, family=binomial(link=logit))
    summary(mod)
    anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Origin="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Origin="Tukey")))

jpeg(file=paste("Model 2 - Survival ~ Origin.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Origin)
effects$Origin <- factor(effects$Origin)
effects$tukey <- "a"

mod2 <- ggplot(effects, aes(x=Origin, y=fit, group=1))
mod2+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.1))+ #
  xlab("Origin")+
  ylab("Probability of survival") +
  geom_text(aes(x=Origin, y=upper, label=tukey),nudge_y=0.06)
dev.off()
```

### **Model 03 - Survival by sex (Fig 2B)**

```{r}
animal$Sex <- factor(animal$Sex)
mod <- glm(Fate~Sex, data=animal, family=binomial(link=logit))
summary(mod)
anova(mod,test=c("Chisq"))

    animal2016$Sex <- factor(animal2016$Sex)
    mod <- glm(Fate~Sex, data=animal2016, family=binomial(link=logit))
    summary(mod)
    anova(mod,test=c("Chisq"))
    
pw <- glht(mod, mcp(Sex="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Sex="Tukey")))

jpeg(file=paste("Model 3 - Survival ~ Sex (Fig 2B).jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Sex)
effects$Sex <- factor(effects$Sex)
effects$tukey <- c("a","b")

mod3 <- ggplot(effects, aes(x=Sex, y=fit, group=1))
mod3 <- mod3+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), color="brown", width=0.1) +
  geom_point(shape=21,size=3,fill="brown",color="brown") +
  theme(axis.line=element_line(color="black"), legend.position="none", 
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"), #y axis tick labels
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"), #x axis tick labels
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04))+ #
  xlab("Sex")+
  ylab("Probability of survival") +
  geom_text(aes(x=Sex, y=upper,label=tukey),nudge_y=0.05) +
  theme(legend.position="none")
dev.off()
mod3
```

### **Model 04 - Survival by den sharing**

```{r}
mod <- glm(Fate~CodenPA, data=codenanimal, family=binomial(link=logit))
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(CodenPA="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(CodenPA="Tukey")))

jpeg(file=paste("Model 4 - Survival ~ Den sharing.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$CodenPA)
effects$tukey <- c("a","a")

mod4 <- ggplot(effects, aes(x=CodenPA, y=fit, group=1))
mod4+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") + 
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1)) +
  xlab("")+
  ylab("Probability of survival") +
  geom_text(aes(x=CodenPA, y=upper,label=tukey),nudge_y=0.06)
dev.off()
```

### **Model 05 - Survival by pouch young**

```{r}
mod <- glm(Fate~PYPA, data=femanimal, family=binomial(link=logit))
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(PYPA="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(PYPA="Tukey")))

jpeg(file=paste("Model 5 - Survival ~ Pouch young.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$PYPA)
effects$PYPA <- factor(effects$PYPA)
effects$tukey <- c("a","a")

mod5 <- ggplot(effects, aes(x=PYPA, y=fit, group=1))
mod5+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1)) +
  xlab("Pouch young") +
  ylab("Probability of survival") +
  geom_text(aes(x=PYPA, y=upper,label=tukey),nudge_y=0.06) #not working...
dev.off()
```

## **2.3 Den sharing models**

### **Model 06 - Den sharing by trial**

```{r}
codenanimal$Trial <- factor(codenanimal$Trial)
mod <- glm(CodenPC~Trial, data=codenanimal)
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Trial="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Trial="Tukey")))

#this plot is not right
jpeg(file=paste("Model 6 - Den sharing ~ Trial.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Trial)
effects$Year <- factor(effects$Trial)
effects$tukey <- c("a","a","a")

mod6 <- ggplot(effects, aes(x=Trial, y=fit, group=1))
mod6+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  xlab("Trial")+
  ylab("Percentage of fixes \n found den sharing (%)") +
  geom_text(aes(x=Trial, y=upper,label=tukey),nudge_y=3) #letters not in right position...
dev.off()
```
### **Model 07 - Den sharing by sex**

```{r}
mod <- glm(CodenPC~Sex, data=codenanimal)
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Sex="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Sex="Tukey")))

#this plot is not right
jpeg(file=paste("Model 7 - Den sharing ~  Sex.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Sex)
effects$Sex <- factor(effects$Sex)
effects$tukey <- "a"

mod7 <- ggplot(effects, aes(x=Sex, y=fit, group=1))
mod7+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(), 
        panel.grid.minor=element_blank(), 
        panel.background=element_blank(), 
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  xlab("Sex")+
  ylab("Percentage of fixes \n found den sharing (%)") +
  geom_text(aes(x=Sex, y=upper,label=tukey),nudge_y=3)
dev.off()
```

### **Model 7.5 - Den sharing by origin**

```{r}
mod <- glm(CodenPC~Origin, data=codenanimal)
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Origin="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Origin="Tukey")))

#this plot is not right
jpeg(file=paste("Model 7 - Den sharing ~  Origin.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Origin)
effects$Origin <- factor(effects$Origin)
effects$tukey <- "a"

mod7 <- ggplot(effects, aes(x=Origin, y=fit, group=1))
mod7+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  xlab("Origin")+
  ylab("Percentage of fixes \n found den sharing (%)") +
  geom_text(aes(x=Origin, y=upper,label=tukey),nudge_y=3)
dev.off()
```

## **2.4 Movement models**

### **Model 08 - Survival by movement (Fig 2C)**

```{r}
subdata <- animal[!is.na(animal$MovedPerc),] #changed it to a subdata
subdata$Fate <- as.numeric(as.character(subdata$Fate)) # for some reason it was classified as a character vector
mod <- glm(Fate~MovedPerc, data=subdata, family=binomial(link=logit)) #should be a binomial model
summary(mod)
anova(mod,test=c("Chisq"))

new.dat <- data.frame(MovedPerc=seq(0.12,0.857, length.out=100)) #creates a vector for the prediction function to predict for
predicted <- predict(mod, newdata=new.dat,se.fit=TRUE,type="link") #predicting on link scale
predicted <- data.frame(predicted)
plotdat <- cbind(new.dat,predicted)
plotdat$fit_r <- inv.logit(plotdat$fit) #creating the predicted value by transforming from the link scale to the response scale
plotdat$lower_r <- inv.logit(plotdat$fit-1.96*plotdat$se.fit) #creating rough 95%CIs before transforming to the response scale
plotdat$upper_r <- inv.logit(plotdat$fit+1.96*plotdat$se.fit) #there are more complicated and robust ways such as profiling and permutations...

jpeg(file=paste("Model 8 - Survival ~ Movement (Fig 2C).jpeg"), width=2500, height=2500, units="px", res=800)
mod8 <- ggplot(plotdat, aes(x=MovedPerc, ylim(0,1), y=fit_r, group=1))
mod8 <- mod8+ 
  geom_ribbon(aes(ymin=lower_r,ymax=upper_r,linetype=NA),alpha=0.2,fill="forest green") +
  geom_line(linetype=1,colour="forest green")+
  geom_line(aes(y= upper_r ),linetype=3,colour="forest green",lwd=0.5)+ 
  geom_line(aes(y= lower_r),linetype=3,colour="forest green",lwd=0.5)+
  theme(axis.line=element_line(colour="black"), legend.position="none",
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_x_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04))+
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04))+
  xlab("Proportion of days moved") +
  ylab("Probability of survival")
dev.off()
mod8
```
### **Model 09 - Survival by distance**

```{r}
subdata <- animal[!is.na(animal$DistanceMean),] #changed it to a subdata
subdata$Fate <- as.numeric(as.character(subdata$Fate)) # for some reason it was classified as a character vector
mod <- glm(Fate~DistanceMean, data=subdata, family=binomial(link=logit)) #model including zeros
summary(mod)
anova(mod,test=c("Chisq"))

new.dat <- data.frame(DistanceMean=seq(180,1050, length.out=100)) #creates a vector for the prediction function to predict for
predicted <- predict(mod, newdata=new.dat,se.fit=TRUE,type="link") #predicting on link scale
predicted <- data.frame(predicted)
plotdat <- cbind(new.dat,predicted)
plotdat$fit_r <- inv.logit(plotdat$fit) #creating the predicted value by transforming from the link scale to the response scale
plotdat$lower_r <- inv.logit(plotdat$fit-1.96*plotdat$se.fit) # creating rough 95%CIs before transforming to the response scale
plotdat$upper_r <- inv.logit(plotdat$fit+1.96*plotdat$se.fit)

jpeg(file=paste("Model 9 - Survival ~ Distance.jpeg"), width=2500, height=2500, units="px", res=800)
mod9 <- ggplot(plotdat, aes(x=DistanceMean, y=fit_r, group=1))
mod9+ 
  geom_ribbon(aes(ymin=lower_r,ymax=upper_r,linetype=NA),alpha=0.2,colour="grey40",fill="grey40")+ 
  geom_line(linetype=1,colour="grey40")+
  geom_line(aes(y= upper_r ),linetype=3,colour="grey40",lwd=0.5)+
  geom_line(aes(y= lower_r),linetype=3,colour="grey40",lwd=0.5)+
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1))+ 
  xlab("Distance moved between dens (m)") +
  ylab("Probability of survival")
dev.off()
```

***Excluding zeros***

```{r}
subdata <- animal[!is.na(animal$DistanceMeanZero),] #changed it to a subdata
subdata$Fate <- as.numeric(as.character(subdata$Fate)) # for some reason it was classified as a character vector

mod <- glm(Fate~DistanceMeanZero, data=subdata, family=binomial(link=logit)) #model including zeros
summary(mod)
anova(mod,test=c("Chisq"))

mod <- glm(Fate~DistanceMeanZero, data=subdata, family=binomial(link=logit)) #model excluding zeros
summary(mod)
anova(mod,test=c("Chisq"))

new.dat <- data.frame(DistanceMeanZero=seq(180,1050, length.out=100)) #creates a vector for the prediction function to predict for
predicted <- predict(mod, newdata=new.dat,se.fit=TRUE,type="link") #predicting on link scale
predicted <- data.frame(predicted)
plotdat <- cbind(new.dat,predicted)
plotdat$fit_r <- inv.logit(plotdat$fit) #creating the predicted value by transforming from the link scale to the response scale
plotdat$lower_r <- inv.logit(plotdat$fit-1.96*plotdat$se.fit) # creating rough 95%CIs before transforming to the response scale
plotdat$upper_r <- inv.logit(plotdat$fit+1.96*plotdat$se.fit)

jpeg(file=paste("Model 9 - Survival ~ Distance (nozeros).jpeg"), width=2500, height=2500, units="px", res=800)
mod9 <- ggplot(plotdat, aes(x=DistanceMeanZero, y=fit_r, group=1))
mod9+ 
  geom_ribbon(aes(ymin=lower_r,ymax=upper_r,linetype=NA),alpha=0.2,colour="grey40",fill="grey40")+ 
  geom_line(linetype=1,colour="grey40")+
  geom_line(aes(y= upper_r ),linetype=3,colour="grey40",lwd=0.5)+
  geom_line(aes(y= lower_r),linetype=3,colour="grey40",lwd=0.5)+
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1))+ 
  xlab("Distance moved between dens (m)") +
  ylab("Probability of survival")
dev.off()
```

### **Model 10 - Movement by trial (Fig 3A)**

```{r}
codenanimal$Trial <- factor(codenanimal$Trial)
mod <- glm(MovedPerc~Trial, data=codenanimal)
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Trial="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Trial="Tukey")))

jpeg(file=paste("Model 10 - Movement ~ Trial (Fig 3A).jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Trial)
effects$Trial <- factor(effects$Trial)
effects$tukey <- c("a","b","b")

mod10 <- ggplot(effects, aes(x=Trial, y=fit, group=1))
mod10 <- mod10+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), colour="orange", width=0.1) +
  geom_point(shape=21,size=3,fill="orange",colour="orange") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04)) +
  xlab("Trial") +
  ylab("Proportion of days moved") +
  geom_text(aes(x=Trial, y=upper,label=tukey),nudge_y=0.05)
dev.off()
mod10
```
### **Model 11 - Movement by origin**

```{r}
mod <- glm(MovedPerc~Origin, data=animal)
summary(mod)
anova(mod,test=c("Chisq"))

    mod <- glm(MovedPerc~Origin, data=animal20162017)
    summary(mod)
    anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Origin="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Origin="Tukey")))

jpeg(file=paste("Model 11 - Movement ~ Origin.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Origin)
effects$Origin <- factor(effects$Origin)
effects$tukey <- "a"

mod11 <- ggplot(effects, aes(x=Origin, y=fit, group=1))
mod11+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1)) +
  xlab("Origin")+
  ylab("Proportion of days moved") +
  geom_text(aes(x=Origin, y=upper,label=tukey),nudge_y=0.06)
dev.off()
```

### **Model 12 - Movement by sex (Fig 3B)**

```{r}
mod <- glm(MovedPerc~Sex, data=animal)
summary(mod)
anova(mod,test=c("Chisq"))

    mod <- glm(MovedPerc~Sex, data=animal2016)
    summary(mod)
    anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(Sex="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(Sex="Tukey")))

jpeg(file=paste("Model 12 - Movement ~ Sex (Fig 3B).jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$Sex)
effects$Sex <- factor(effects$Sex)
effects$tukey <- c("a","b")

mod12 <- ggplot(effects, aes(x=Sex, y=fit, group=1))
mod12 <- mod12+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), colour="brown", width=0.1) +
  geom_point(shape=21,size=3,fill="brown",colour="brown") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04)) +
  xlab("Sex")+
  ylab("Proportion of days moved") +
  geom_text(aes(x=Sex, y=upper,label=tukey),nudge_y=0.05)
dev.off()
mod12
```

### **Model 13 - Movement by den sharing (Fig 3C)**

```{r}
hist(logit(codenanimal$MovedPerc))
mod <- glm(MovedPerc~CodenPA, data=codenanimal)
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(CodenPA="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(CodenPA="Tukey")))

jpeg(file=paste("Model 13 - Movement ~ Den sharing (Fig 3C).jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$CodenPA)
effects$tukey <- c("a","b")

mod13 <- ggplot(effects, aes(x=CodenPA, y=fit, group=1))
mod13 <- mod13+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), colour="forest green", width=0.1) +
  geom_point(shape=21,size=3,fill="forest green",colour="forest green") +
  theme(axis.line=element_line(colour="black"),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1.04)) +
  xlab("")+
  ylab("Proportion of days moved") +
  geom_text(aes(x=CodenPA, y=upper,label=tukey),nudge_y=0.05)
dev.off()
mod13
```
### **Model 14 - Movement by pouch young**

```{r}
mod <- glm(MovedPerc~PYPA, data=femanimal)
summary(mod)
anova(mod,test=c("Chisq"))

pw <- glht(mod, mcp(PYPA="Tukey"))  
ph <- cld(pw, alpha=0.050, Letters=letters, adjust="tukey")
summary(glht(mod, mcp(PYPA="Tukey")))

jpeg(file=paste("Model 14 - Movement ~ Pouch young.jpeg"), width=2500, height=2500, units="px", res=800)
effects <- allEffects(mod)
effects <- data.frame(effects$PYPA)
effects$PYPA <- factor(effects$PYPA)
effects$tukey <- c("a","a")

mod14 <- ggplot(effects, aes(x=PYPA, y=fit, group=1))
mod14+ 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1) +
  geom_point(shape=21,size=3,fill="black",colour="black") +
  theme(axis.line=element_line(colour="black"),
        #legend.position="none" #legend
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank(),
        axis.text.y=element_text(angle=0, vjust=0.5,color="black"), #y axis tick label
        axis.text.x=element_text(angle=0, vjust=0.5,color="black"),
        axis.title=element_text(),
        strip.text.y=element_blank()) +
  scale_y_continuous(breaks=seq(0,1,0.2),labels=seq(0,1,0.2), limits=c(0,1)) +
  xlab("Pouch young") +
  ylab("Probability of survival") +
  geom_text(aes(x=PYPA, y=upper,label=tukey),nudge_y=0.06) #not working...
dev.off()
```

## **2.5 Combine plots**

```{r}
library(ggpubr)
Fig2 <- ggarrange(mod1, mod3 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), mod8 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), heights=c(3,3),widths=c(3,3), #y axis titles
                label.x=0.89, label.y=0.99, hjust=-0.5, vjust=1.5, #figure labels
                #labels=c("2A","2B", "2C"), #figure labels
                ncol=3, nrow=1, #align="h", #arrangement of matrix
                font.label=list(size=10, face="bold", color ="black"))
ggsave(filename="Fig2.tiff", Fig2, width=190, height=75, units="mm")
Fig2

Fig3 <- ggarrange(mod10, mod12 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), mod13 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), heights=c(3, 3),widths=c(3,3) , #y axis titles
                label.x=0.89, label.y=0.99, hjust=-0.5, vjust=1.5, #figure labels
                #labels=c("3A","3B","3C"), #figure labels
                ncol=3, nrow=1, #align="h", #arrangement of matrix
                font.label=list(size=10, face="bold", color ="black"))
ggsave(filename="Fig3.tiff", Fig3, width=190, height=75, units="mm")
Fig3
```

# **3. Model selection**

## **3.1 Survival by trial and sex**

```{r, results='hide'}
library(MuMIn)
```

```{r}
animal$Trial <- factor(animal$Trial)
animal$Sex <- factor(animal$Sex)
mod1 <- glm(Fate~Trial+Sex, data=animal, family=binomial(link=logit))

mod3 <- glm(Fate~Trial, data=animal, family=binomial(link=logit))
mod4 <- glm(Fate~Sex, data=animal, family=binomial(link=logit))
AICc(mod1, mod3, mod4)
summary(mod2)
```

## **3.2 Movement by trial and sex**

```{r}
animal$Trial <- factor(animal$Trial)
animal$Sex <- factor(animal$Sex)
mod1 <- glm(MovedPerc~Trial+Sex, data=animal)
mod2 <- glm(MovedPerc~Trial*Sex, data=animal)
mod3 <- glm(MovedPerc~Trial, data=animal)
mod4 <- glm(MovedPerc~Sex, data=animal)
AICc(mod1, mod2, mod3, mod4)
```

## **3.3 Combine plots**

```{r}
library(ggpubr)
Fig2 <- ggarrange(mod1, mod3 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), mod8 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), heights=c(3,3),widths=c(3,3), #y axis titles
                label.x=0.89, label.y=0.99, hjust=-0.5, vjust=1.5, #figure labels
                labels=c("2A","2B", "2C"), #figure labels
                ncol=3, nrow=1, #align="h", #arrangement of matrix
                font.label=list(size=10, face="bold", color ="black"))
ggsave(filename="Fig2.tiff", Fig2, width=190, height=75, units="mm")
Fig2

Fig3 <- ggarrange(mod10, mod12 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), mod13 + rremove("ylab") + rremove ("y.text") + rremove ("y.ticks"), heights=c(3, 3),widths=c(3,3) , #y axis titles
                label.x=0.89, label.y=0.99, hjust=-0.5, vjust=1.5, #figure labels
                labels=c("3A","3B","3C"), #figure labels
                ncol=3, nrow=1, #align="h", #arrangement of matrix
                font.label=list(size=10, face="bold", color ="black"))
ggsave(filename="Fig3.tiff", Fig3, width=190, height=75, units="mm")
Fig3
```
